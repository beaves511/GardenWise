name: GardenWise Full CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Added Schedule trigger for daily maintenance checks (optional, but robust)
  schedule:
    - cron: '0 4 * * *' # Runs every day at 04:00 UTC

jobs:
  # Job 1: Build and Analyze Python Backend
  backend_analysis:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend # Set context for backend directory
    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v4
    
    - name: 2. Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: 3.11
        cache: 'pip'

    - name: 3. Install Python Dependencies (for Analysis)
      run: |
        pip install -r requirements.txt || true  # Attempt to install from requirements.txt
        # Install necessary security and test tools
        pip install flake8 pytest pytest-cov bandit

    - name: 4. Add Backend Root to Python Path
      # This step makes 'db_service' and other root modules importable by tests in subdirectories
      run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
        
    - name: Debug directory structure
      run: |
        pwd
        ls -R

    - name: 6. Run Pytest Unit Tests
      run: python -m pytest tests/test_services.py --cov=. --cov-report=xml

    - name: 5. Perform Static Analysis (Flake8 & Bandit)
      run: |
        # Flake8: General Style and Code Quality
        echo "--- Running Flake8 (Style/Quality Check) ---"
        flake8 . --count --show-source --statistics

        # Bandit: Security Vulnerability Scanner
        echo "--- Running Bandit (Security Check) ---"
        # Scans for common security issues (e.g., hardcoded secrets, dangerous functions)
        bandit -r . -x ./tests/* -ll -q

        
    - name: 7. Upload Coverage Report (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-report
        path: ./backend/coverage.xml

  # Job 2: Build and Test Next.js Frontend
  frontend_build:
    runs-on: ubuntu-latest
    needs: backend_analysis # Frontend runs only if backend analysis succeeds
    defaults:
      run:
        working-directory: ./frontend # Set context for frontend directory
    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v4
    
    - name: 2. Set up Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: 3. Install NPM Dependencies
      run: npm install
      
    - name: 4. Run ESLint (Static Analysis)
      # CRITICAL FIX: Explicitly run linting to check code quality/syntax errors
      run: npm run lint
      working-directory: ./frontend

    - name: 5. Run Next.js Build Check (Compilation)
      run: npm run build
      env:
        # Provide placeholder environment variables to allow the build to complete
        NEXT_PUBLIC_API_BASE_URL: http://localhost
